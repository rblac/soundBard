<!doctype html>
<html lang="en">
	<head>
		<title>SoundBard console</title>
		<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
		<!--<script src="/web/index.js">-->
		<style>
body {
	font-family: sans-serif;
	background: #223;
	color: #eee;
}
div {
	padding: 1em;
}
button {
	padding: 1em;
	font-weight: bold;
	background: #334;
	color: #eee;
	border-radius: 0.3em;
	border-color: #557;
}
input {
	background: #223;
	color: #eee;
	font-size: 100%;
}
		</style>
	</head>
	<body>
		<h1>SoundBard web interface</h1>

		<!--<button onclick="test()">test</button>-->
		<hr>
		<p><span id="sStatus">not connected</span></p>
		User: <input id="itTestUser" />
		<button onclick="updateUser()">connect</button>
		<hr>
		<!--<form id="fUpload" action="/upload" method="post" enctype="multipart/form-data">-->
		<input type=file accept=audio/* name="sound" id="ifUpload" />
		<button onclick="upload()">upload</button>

		<div id="dSoundList">
		</div>

		<script>
			const socket = io();

			const createRow = (s) => {
				return `<tr id="tr-${s.id}"><th scope="row">${s.path}</td><td>${s.author}</td>` +
						`<td><button onclick="playSound(${s.id})">PLAY</button></td>` +
						`<td><button onclick="deleteSound(${s.id})">X</button></td>` +
						`<td><input type="checkbox" ${s.canManage?'enabled':'disabled'} `+
							`id="cbVis-${s.id}" ${s.communal?'checked':'unchecked'} `+
							`onchange="changeVis(${s.id}, this)" /></td>` +
						`</tr>`
			};
			function htmlToDOM(html) {
				var temp = document.createElement('template');
				temp.innerHTML = html.trim();
				return temp.content.firstChild;
			}

			socket.on('list-data', (data) => {
				const dl = document.getElementById("dSoundList");

				var b = '<table id="tSounds">'+
						'<thead> <tr>'+
							'<th scope="col">name</th>'+
							'<th scope="col">author</th>'+
							'<th scope="col">play</th>'+
							'<th scope="col">delete</th>'+
							'<th scope="col">public</th>'+
						'</tr></thead>'+
						'<tbody>';
				data.forEach((s) => b += createRow(s));
				b += "</tbody></table>";

				dl.innerHTML = b;
			})
			socket.on('new-sound', (s) => {
				const tb = document.getElementById("tSounds").getElementsByTagName('tbody')[0];
				const newRow = htmlToDOM(createRow(s));
				tb.appendChild(newRow);
			})
			socket.on('del-sound', (id) => {
				const tb = document.getElementById("tSounds").getElementsByTagName('tbody')[0];
				tb.removeChild(document.getElementById(`tr-${id}`));
			});
			socket.on('vis', (id, vis) => {
				console.log(vis)
				//document.getElementById(`cbVis-${id}`).checked = vis;
			});

			socket.on('ack-user', (username) => {
				document.getElementById("sStatus").innerText = `connected as ${username}`;
			});

			function updateUser() {
				const un = document.getElementById("itTestUser").value;
				socket.emit('set-user', un);
			}
			if(document.getElementById("itTestUser").value)
				updateUser();

			function playSound(id) {
				socket.emit('play', id);
			}
			function deleteSound(id) {
				socket.emit('delete', id);
			}
			function changeVis(id, toggle) {
				const isPublic = toggle.checked;
				socket.emit('set-vis', id, isPublic)
			}
			function setupList() {
				socket.emit('list')
			}
			setupList();

			function upload() {
				const files = document.getElementById("ifUpload").files;
				if(!files || files.length != 1) {
					alert("select exactly 1 file.");
					return;
				}
				socket.emit('upload', files[0].name, files[0]);
			}
			function test() {
				socket.emit('test');
			}
		</script>
	</body>
</html>
